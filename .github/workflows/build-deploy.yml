name: Build and Deploy APT Repository

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  repository_dispatch:
    types: [upload-package]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-repository:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Install reprepro
      run: |
        sudo apt-get update
        sudo apt-get install -y reprepro gnupg

    - name: Import GPG key
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        if [ -n "$GPG_PRIVATE_KEY" ]; then
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "GPG key imported successfully"
        else
          echo "Warning: No GPG key found in secrets. Repository will not be signed."
          # Remove SignWith from distributions file temporarily
          sed -i '/SignWith:/d' conf/distributions
        fi

    - name: Download package from dispatch event
      if: github.event_name == 'repository_dispatch'
      run: |
        echo "Processing repository dispatch event"
        PACKAGE_URL="${{ github.event.client_payload.package_url }}"
        PACKAGE_NAME="${{ github.event.client_payload.package_name }}"
        DISTRIBUTION="${{ github.event.client_payload.distribution }}"
        
        if [ -n "$PACKAGE_URL" ] && [ -n "$PACKAGE_NAME" ]; then
          echo "Downloading package: $PACKAGE_NAME"
          mkdir -p incoming
          curl -L -o "incoming/$PACKAGE_NAME" "$PACKAGE_URL"
          echo "PACKAGE_FILE=incoming/$PACKAGE_NAME" >> $GITHUB_ENV
          echo "DISTRIBUTION=${DISTRIBUTION:-stable}" >> $GITHUB_ENV
        fi

    - name: Process incoming packages
      run: |
          echo "Processing incoming packages..."
          
          # Create necessary directories if they don't exist
          mkdir -p dists pool
          
          # Process stable packages
          for component in main contrib; do
            stable_dir="incoming/stable/$component"
            if [ -d "$stable_dir" ] && [ "$(ls -A $stable_dir/*.deb 2>/dev/null || true)" ]; then
              echo "Found packages in $stable_dir:"
              ls -la "$stable_dir/"
              
              for deb in "$stable_dir"/*.deb; do
                if [ -f "$deb" ]; then
                  echo "Adding $deb to stable distribution (component: $component)..."
                  reprepro -C "$component" includedeb stable "$deb"
                  rm "$deb"
                fi
              done
            else
              echo "No packages found in $stable_dir/"
            fi
          done
          
          # Process testing packages
          for component in main contrib; do
            testing_dir="incoming/testing/$component"
            if [ -d "$testing_dir" ] && [ "$(ls -A $testing_dir/*.deb 2>/dev/null || true)" ]; then
              echo "Found packages in $testing_dir:"
              ls -la "$testing_dir/"
              
              for deb in "$testing_dir"/*.deb; do
                if [ -f "$deb" ]; then
                  echo "Adding $deb to testing distribution (component: $component)..."
                  reprepro -C "$component" includedeb testing "$deb"
                  rm "$deb"
                fi
              done
            else
              echo "No packages found in $testing_dir/"
            fi
          done
          
          # Process any legacy packages in root incoming directory (for backwards compatibility)
          if [ -d incoming ] && [ "$(ls -A incoming/*.deb 2>/dev/null || true)" ]; then
            echo "Processing legacy packages in root incoming directory..."
            for deb_file in incoming/*.deb; do
              if [ -f "$deb_file" ]; then
                echo "Processing legacy package: $deb_file"
                package_name=$(dpkg-deb -f "$deb_file" Package)
                version=$(dpkg-deb -f "$deb_file" Version)
                
                # Default to stable for legacy uploads
                echo "Adding legacy package to stable distribution"
                reprepro includedeb stable "$deb_file"
                rm "$deb_file"
              fi
            done
          fi
          
          if [ ! -f incoming/stable/main/*.deb ] && [ ! -f incoming/stable/contrib/*.deb ] && [ ! -f incoming/testing/main/*.deb ] && [ ! -f incoming/testing/contrib/*.deb ] && [ ! -f incoming/*.deb ]; then
            echo "No new packages to process"
          fi

    - name: Generate repository metadata
      run: |
        # Export repository
        reprepro export
        
        # Generate package lists
        echo "Repository contents:" > repository-info.txt
        reprepro list stable >> repository-info.txt 2>/dev/null || true
        reprepro list testing >> repository-info.txt 2>/dev/null || true

    - name: Create index page
      run: |
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ADB APT Repository</h1>
                <p>Welcome to the ADB APT repository. This repository hosts Debian packages.</p>
                
                <h2>Quick Setup</h2>
                <p>Add this repository to your system:</p>
                <pre class="command">
        # Add the repository
        echo "deb https://adambirds.github.io/adb-apt-repo stable main" | sudo tee /etc/apt/sources.list.d/adb-apt-repo.list
        
        # Add the GPG key (modern method)
        curl -fsSL https://adambirds.github.io/adb-apt-repo/pubkey.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/adb-apt-repo.gpg
        
        # Update package list
        sudo apt update
                </pre>
                
                <h2>Alternative Setup (for older systems)</h2>
                <p>If you're using an older Ubuntu/Debian version:</p>
                <pre class="command">
        # Add the repository
        echo "deb https://adambirds.github.io/adb-apt-repo stable main" | sudo tee /etc/apt/sources.list.d/adb-apt-repo.list
        
        # Add the GPG key (legacy method)
        curl -fsSL https://adambirds.github.io/adb-apt-repo/pubkey.gpg | sudo apt-key add -
        
        # Update package list
        sudo apt update
                </pre>
                
                <h2>Available Distributions</h2>
                <ul>
                    <li><strong>stable</strong> - Stable packages</li>
                    <li><strong>testing</strong> - Testing packages</li>
                </ul>
                
                <h2>Available Components</h2>
                <ul>
                    <li><strong>main</strong> - Main packages</li>
                    <li><strong>contrib</strong> - Contributed packages</li>
                </ul>
                
                <h2>Repository Information</h2>
                <ul>
                    <li><a href="./dists/">Browse distributions</a></li>
                    <li><a href="./pool/">Browse packages</a></li>
                    <li><a href="./pubkey.gpg">Download GPG public key</a></li>
                </ul>
                
                <p><em>Last updated: </em></p>
            </div>
        </body>
        </html>
        EOF
        
        # Add the current date to the index page
        sed -i "s|Last updated: </em>|Last updated: $(date)</em>|" index.html

    - name: Create directory index pages
      run: |
        # Create .nojekyll to prevent GitHub Pages from processing files
        touch .nojekyll
        
        # Create dists/index.html
        cat > dists/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Distributions</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Repository</a></div>
                <h1>Distributions</h1>
                <p>Available distributions in this APT repository:</p>
                <ul>
                    <li><a href="stable/"><strong>stable/</strong> - Stable packages for production use</a></li>
                    <li><a href="testing/"><strong>testing/</strong> - Testing packages for development</a></li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Create pool/index.html
        cat > pool/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Package Pool</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Repository</a></div>
                <h1>Package Pool</h1>
                <p>Package pool organized by component:</p>
                <ul>
                    <li><a href="main/"><strong>main/</strong> - Main component packages</a></li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Create dists/stable/index.html
        cat > dists/stable/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Stable Distribution</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Distributions</a></div>
                <h1>Stable Distribution</h1>
                <p>Components available in the stable distribution:</p>
                <ul>
                    <li><a href="main/"><strong>main/</strong> - Main packages</a></li>
                    <li><a href="contrib/"><strong>contrib/</strong> - Contributed packages</a></li>
                </ul>
                <h2>Repository Metadata</h2>
                <ul>
                    <li><a href="Release">Release</a> - Distribution release information</li>
                    <li><a href="Release.gpg">Release.gpg</a> - GPG signature</li>
                    <li><a href="InRelease">InRelease</a> - Inline signed release</li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Create dists/testing/index.html
        cat > dists/testing/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Testing Distribution</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Distributions</a></div>
                <h1>Testing Distribution</h1>
                <p>Components available in the testing distribution:</p>
                <ul>
                    <li><a href="main/"><strong>main/</strong> - Main packages</a></li>
                    <li><a href="contrib/"><strong>contrib/</strong> - Contributed packages</a></li>
                </ul>
                <h2>Repository Metadata</h2>
                <ul>
                    <li><a href="Release">Release</a> - Distribution release information</li>
                    <li><a href="Release.gpg">Release.gpg</a> - GPG signature</li>
                    <li><a href="InRelease">InRelease</a> - Inline signed release</li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Create dists/stable/main/index.html
        cat > dists/stable/main/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Stable/Main</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Stable</a></div>
                <h1>Stable - Main Component</h1>
                <p>Binary packages for different architectures:</p>
                <ul>
                    <li><a href="binary-amd64/"><strong>binary-amd64/</strong> - AMD64 packages</a></li>
                    <li><a href="binary-arm64/"><strong>binary-arm64/</strong> - ARM64 packages</a></li>
                    <li><a href="binary-armhf/"><strong>binary-armhf/</strong> - ARM hard-float packages</a></li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Create dists/testing/main/index.html
        cat > dists/testing/main/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Testing/Main</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Testing</a></div>
                <h1>Testing - Main Component</h1>
                <p>Binary packages for different architectures:</p>
                <ul>
                    <li><a href="binary-amd64/"><strong>binary-amd64/</strong> - AMD64 packages</a></li>
                    <li><a href="binary-arm64/"><strong>binary-arm64/</strong> - ARM64 packages</a></li>
                    <li><a href="binary-armhf/"><strong>binary-armhf/</strong> - ARM hard-float packages</a></li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Create binary architecture pages for stable/main
        for arch in amd64 arm64 armhf; do
          cat > "dists/stable/main/binary-$arch/index.html" << EOF
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Stable/Main/$arch</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Main</a></div>
                <h1>Stable - Main - $arch</h1>
                <p>Package metadata files for $arch architecture:</p>
                <ul>
                    <li><a href="Packages"><strong>Packages</strong> - Package list</a></li>
                    <li><a href="Packages.gz"><strong>Packages.gz</strong> - Compressed package list</a></li>
                    <li><a href="Release"><strong>Release</strong> - Release information</a></li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        done
        
        # Create binary architecture pages for testing/main
        for arch in amd64 arm64 armhf; do
          cat > "dists/testing/main/binary-$arch/index.html" << EOF
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Testing/Main/$arch</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Main</a></div>
                <h1>Testing - Main - $arch</h1>
                <p>Package metadata files for $arch architecture:</p>
                <ul>
                    <li><a href="Packages"><strong>Packages</strong> - Package list</a></li>
                    <li><a href="Packages.gz"><strong>Packages.gz</strong> - Compressed package list</a></li>
                    <li><a href="Release"><strong>Release</strong> - Release information</a></li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        done
        
        # Create pool/main/index.html
        if [ -d "pool/main" ]; then
          cat > pool/main/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Main Component Pool</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Pool</a></div>
                <h1>Main Component Pool</h1>
                <p>Packages organized by first letter:</p>
                <ul>
        EOF
          
          # List actual directories in pool/main
          for dir in pool/main/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "                    <li><a href=\"$dirname/\"><strong>$dirname/</strong> - Packages starting with '$dirname'</a></li>" >> pool/main/index.html
            fi
          done
          
          cat >> pool/main/index.html << 'EOF'
                </ul>
            </div>
        </body>
        </html>
        EOF
        fi
        
        # Create index pages for letter directories and package directories
        find pool -type d -mindepth 2 | while read -r dir; do
          if [ -d "$dir" ]; then
            letter=$(basename "$(dirname "$dir")")
            if [ "$(dirname "$dir")" = "pool/main" ]; then
              # This is a letter directory like pool/main/p/
              cat > "$dir/index.html" << EOF
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - Packages starting with '$letter'</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to Main Pool</a></div>
                <h1>Packages starting with '$letter'</h1>
                <p>Available packages:</p>
                <ul>
        EOF
              
              # List package directories
              for pkg_dir in "$dir"/*; do
                if [ -d "$pkg_dir" ]; then
                  pkg_name=$(basename "$pkg_dir")
                  echo "                    <li><a href=\"$pkg_name/\"><strong>$pkg_name/</strong></a></li>" >> "$dir/index.html"
                fi
              done
              
              cat >> "$dir/index.html" << 'EOF'
                </ul>
            </div>
        </body>
        </html>
        EOF
            else
              # This is a package directory like pool/main/p/pypi-package-updater/
              pkg_name=$(basename "$dir")
              cat > "$dir/index.html" << EOF
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository - $pkg_name</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
                .breadcrumb { color: #666; margin-bottom: 20px; }
                ul li { margin: 8px 0; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="breadcrumb"><a href="../">← Back to $(basename "$(dirname "$dir")")</a></div>
                <h1>Package: $pkg_name</h1>
                <p>Available package files:</p>
                <ul>
        EOF
              
              # List .deb files
              for file in "$dir"/*.deb; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  echo "                    <li><a href=\"$filename\"><strong>$filename</strong> - Debian package</a></li>" >> "$dir/index.html"
                fi
              done
              
              cat >> "$dir/index.html" << 'EOF'
                </ul>
            </div>
        </body>
        </html>
        EOF
            fi
          fi
        done
        
        echo "Created all directory index pages with consistent styling"

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-repository
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
