name: Build and Deploy APT Repository

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  repository_dispatch:
    types: [upload-package]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-repository:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Install reprepro
      run: |
        sudo apt-get update
        sudo apt-get install -y reprepro gnupg

    - name: Import GPG key
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        if [ -n "$GPG_PRIVATE_KEY" ]; then
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "GPG key imported successfully"
        else
          echo "Warning: No GPG key found in secrets. Repository will not be signed."
          # Remove SignWith from distributions file temporarily
          sed -i '/SignWith:/d' conf/distributions
        fi

    - name: Download package from dispatch event
      if: github.event_name == 'repository_dispatch'
      run: |
        echo "Processing repository dispatch event"
        PACKAGE_URL="${{ github.event.client_payload.package_url }}"
        PACKAGE_NAME="${{ github.event.client_payload.package_name }}"
        DISTRIBUTION="${{ github.event.client_payload.distribution }}"
        
        if [ -n "$PACKAGE_URL" ] && [ -n "$PACKAGE_NAME" ]; then
          echo "Downloading package: $PACKAGE_NAME"
          mkdir -p incoming
          curl -L -o "incoming/$PACKAGE_NAME" "$PACKAGE_URL"
          echo "PACKAGE_FILE=incoming/$PACKAGE_NAME" >> $GITHUB_ENV
          echo "DISTRIBUTION=${DISTRIBUTION:-stable}" >> $GITHUB_ENV
        fi

    - name: Process incoming packages
      run: |
          echo "Processing incoming packages..."
          
          # Create necessary directories if they don't exist
          mkdir -p dists pool
          
          # Process stable packages
          for component in main contrib; do
            stable_dir="incoming/stable/$component"
            if [ -d "$stable_dir" ] && [ "$(ls -A $stable_dir/*.deb 2>/dev/null || true)" ]; then
              echo "Found packages in $stable_dir:"
              ls -la "$stable_dir/"
              
              for deb in "$stable_dir"/*.deb; do
                if [ -f "$deb" ]; then
                  echo "Adding $deb to stable distribution (component: $component)..."
                  reprepro -C "$component" includedeb stable "$deb"
                  rm "$deb"
                fi
              done
            else
              echo "No packages found in $stable_dir/"
            fi
          done
          
          # Process testing packages
          for component in main contrib; do
            testing_dir="incoming/testing/$component"
            if [ -d "$testing_dir" ] && [ "$(ls -A $testing_dir/*.deb 2>/dev/null || true)" ]; then
              echo "Found packages in $testing_dir:"
              ls -la "$testing_dir/"
              
              for deb in "$testing_dir"/*.deb; do
                if [ -f "$deb" ]; then
                  echo "Adding $deb to testing distribution (component: $component)..."
                  reprepro -C "$component" includedeb testing "$deb"
                  rm "$deb"
                fi
              done
            else
              echo "No packages found in $testing_dir/"
            fi
          done
          
          # Process any legacy packages in root incoming directory (for backwards compatibility)
          if [ -d incoming ] && [ "$(ls -A incoming/*.deb 2>/dev/null || true)" ]; then
            echo "Processing legacy packages in root incoming directory..."
            for deb_file in incoming/*.deb; do
              if [ -f "$deb_file" ]; then
                echo "Processing legacy package: $deb_file"
                package_name=$(dpkg-deb -f "$deb_file" Package)
                version=$(dpkg-deb -f "$deb_file" Version)
                
                # Default to stable for legacy uploads
                echo "Adding legacy package to stable distribution"
                reprepro includedeb stable "$deb_file"
                rm "$deb_file"
              fi
            done
          fi
          
          if [ ! -f incoming/stable/main/*.deb ] && [ ! -f incoming/stable/contrib/*.deb ] && [ ! -f incoming/testing/main/*.deb ] && [ ! -f incoming/testing/contrib/*.deb ] && [ ! -f incoming/*.deb ]; then
            echo "No new packages to process"
          fi

    - name: Generate repository metadata
      run: |
        # Export repository
        reprepro export
        
        # Generate package lists
        echo "Repository contents:" > repository-info.txt
        reprepro list stable >> repository-info.txt 2>/dev/null || true
        reprepro list testing >> repository-info.txt 2>/dev/null || true
        
        # Debug: Check what directories were created
        echo "=== Debugging: Directory structure after reprepro ==="
        ls -la
        echo "=== Contents of dists/ directory ==="
        ls -la dists/ || echo "dists/ directory not found"
        echo "=== Contents of pool/ directory ==="
        ls -la pool/ || echo "pool/ directory not found"
        echo "=== Full directory tree ==="
        find . -type d | head -20

    - name: Create index page
      run: |
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ADB APT Repository</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                .command { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ADB APT Repository</h1>
                <p>Welcome to the ADB APT repository. This repository hosts Debian packages.</p>
                
                <h2>Quick Setup</h2>
                <p>Add this repository to your system:</p>
                <pre class="command">
        # Add the repository
        echo "deb https://adambirds.github.io/adb-apt-repo stable main" | sudo tee /etc/apt/sources.list.d/adb-apt-repo.list
        
        # Add the GPG key
        curl -fsSL https://adambirds.github.io/adb-apt-repo/pubkey.gpg | sudo apt-key add -
        
        # Update package list
        sudo apt update
                </pre>
                
                <h2>Available Distributions</h2>
                <ul>
                    <li><strong>stable</strong> - Stable packages</li>
                    <li><strong>testing</strong> - Testing packages</li>
                </ul>
                
                <h2>Available Components</h2>
                <ul>
                    <li><strong>main</strong> - Main packages</li>
                    <li><strong>contrib</strong> - Contributed packages</li>
                </ul>
                
                <h2>Repository Information</h2>
                <ul>
                    <li><a href="./dists/">Browse distributions</a></li>
                    <li><a href="./pool/">Browse packages</a></li>
                    <li><a href="./pubkey.gpg">Download GPG public key</a></li>
                </ul>
                
                <p><em>Last updated: $(date)</em></p>
            </div>
        </body>
        </html>
        EOF

    - name: Create directory index files for GitHub Pages
      run: |
        # Create index.html files for main directories that APT clients access
        
        # Main dists directory
        cat > dists/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>APT Repository - Distributions</title>
        </head>
        <body>
            <h1>APT Repository - Distributions</h1>
            <p>Available distributions:</p>
            <ul>
                <li><a href="stable/">stable/</a></li>
                <li><a href="testing/">testing/</a></li>
            </ul>
        </body>
        </html>
        EOF
        
        # Main pool directory
        cat > pool/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>APT Repository - Package Pool</title>
        </head>
        <body>
            <h1>APT Repository - Package Pool</h1>
            <p>Package pool organized by component:</p>
            <ul>
                <li><a href="main/">main/</a></li>
            </ul>
        </body>
        </html>
        EOF
        
        # Create .nojekyll to prevent GitHub Pages from processing files
        touch .nojekyll
        
        # Create index files for subdirectories that exist
        if [ -d "pool/main" ]; then
          cat > pool/main/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>APT Repository - Main Component</title>
        </head>
        <body>
            <h1>APT Repository - Main Component</h1>
            <p>Packages in the main component, organized by first letter:</p>
            <ul>
        EOF
          
          # List subdirectories in pool/main
          for dir in pool/main/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "                <li><a href=\"$dirname/\">$dirname/</a></li>" >> pool/main/index.html
            fi
          done
          
          cat >> pool/main/index.html << 'EOF'
            </ul>
        </body>
        </html>
        EOF
        fi
        
        # Create index files for package directories
        find pool -type d -mindepth 3 -maxdepth 3 | while read -r dir; do
          cat > "$dir/index.html" << EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>APT Repository - $(basename "$dir")</title>
        </head>
        <body>
            <h1>Package: $(basename "$dir")</h1>
            <p>Available package files:</p>
            <ul>
        EOF
          
          # List .deb files in this directory
          for file in "$dir"/*.deb; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "                <li><a href=\"$filename\">$filename</a></li>" >> "$dir/index.html"
            fi
          done
          
          cat >> "$dir/index.html" << 'EOF'
            </ul>
        </body>
        </html>
        EOF
        done
        
        # Create index files for distribution subdirectories
        for dist in stable testing; do
          if [ -d "dists/$dist" ]; then
            cat > "dists/$dist/index.html" << EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>APT Repository - $dist Distribution</title>
        </head>
        <body>
            <h1>$dist Distribution</h1>
            <p>Available components:</p>
            <ul>
                <li><a href="main/">main/</a></li>
                <li><a href="contrib/">contrib/</a></li>
            </ul>
            <p>Repository metadata:</p>
            <ul>
                <li><a href="Release">Release</a></li>
                <li><a href="Release.gpg">Release.gpg</a></li>
                <li><a href="InRelease">InRelease</a></li>
            </ul>
        </body>
        </html>
        EOF
          fi
        done
        
        echo "Created directory index files for GitHub Pages compatibility"

    - name: Debug artifact contents before upload
      run: |
        echo "=== Final directory structure before upload ==="
        ls -la
        echo "=== Files to be uploaded ==="
        find . -type f | grep -E "(dists|pool|index\.html)" | head -20
        echo "=== Total file count ==="
        find . -type f | wc -l

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-repository
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
